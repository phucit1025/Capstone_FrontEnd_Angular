<div class="pos-relative">
  <div nz-row class="w-full mb-2">
    <div nz-col nzMd nzSpan="24" style="text-align: center">
      <h2>Surgery schedule</h2>
    </div>
  </div>
  <!--loading-->
  <div *ngIf="state.load" class="container" style="text-align: center">
    <nz-spin class="isLoad" [nzSize]="'large'"></nz-spin>
  </div>
  <ng-container *ngIf="!state.load && state.finish">
    <div nz-row>
      <div nz-col nzMd nzSpan="12">
        <nz-form-item>
          <nz-form-label>
            <b style="font-size: 1.2em">Current Date</b>
          </nz-form-label>
          <nz-form-control>
            <h1><b style="color: black">{{serverTime | date: 'dd/MM/yyyy'}}</b></h1>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col nzMd nzSpan="12">
        <nz-form-item>
          <nz-form-label>
            <b style="font-size: 1.2em">Time</b>
          </nz-form-label>
          <nz-form-control>
            <h1><b style="color: black">{{serverTime | date: 'HH : mm : ss'}}</b></h1>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div nz-row nzAlign="bottom" nzType="flex">
      <div nz-col nzMd nzSpan="12">
        <nz-form-item>
          <nz-form-label nzFor="date">
            <b style="font-size: 1.2em">Schedule by date</b>
          </nz-form-label>
          <nz-form-control>
            <nz-date-picker name="date" id="date" nzFormat="dd-MM-yyyy" [ngModel]="date" nzAllowClear='false'
              (ngModelChange)="changeDate($event)">
            </nz-date-picker>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div nz-col nzMd nzSpan="12" class="pr-2">
        <nz-form-item>
          <div class="d-flex">
            <nz-input-group class="mr-2" [nzSuffix]="suffixIconSearch">
              <input [(ngModel)]="state.searchText" type="text" nz-input placeholder="Search by Id1, Id2, ...">
            </nz-input-group>
            <ng-template #suffixIconSearch>
              <i nz-icon type="search"></i>
            </ng-template>
            <button *ngIf="!state.swapMode" (click)="state.swapMode = true" nz-button nzType="primary">Enable Swap
            </button>
            <button nz-popconfirm nzTitle="Are You Sure You Want To Swap ?" [nzCancelText]="'Cancel'"
              (nzOnConfirm)="swapShift()" *ngIf="state.swapMode"
              [disabled]="!selected.firstShiftId  || !selected.secondShiftId" nz-button nzType="primary" class="mr-2">Swap
            </button>
            <button *ngIf="state.swapMode" (click)="disabled()" nz-button nzType="default">Disable Swap</button>
          </div>
        </nz-form-item>
      </div>
    </div>
    <div nz-row nzAlign="bottom" nzType="flex">
      <div nz-col nzMd nzSpan="12">
        <button (click)="isShowEmergency = true; loadSlotRoom()" class="btn btn-primary">
          Add Emergency Shift
        </button>
      </div>
      <div nz-col nzMd nzSpan="12">
        <div style="float: right">
          <label class="mr-2"><b>Status : </b></label>
          <nz-tag [nzColor]="'#a5d6a7'">Proceeding</nz-tag>
          <nz-tag [nzColor]="'#9e9e9e'">Completed</nz-tag>
        </div>
      </div>
    </div>
    <br>
    <!-- Room Container -->
<<<<<<< HEAD
    <div nz-row id="room-container" class="room-container">
      <ng-container *ngFor="let room of rooms | roomPipe: state.searchText">
=======
    <div id="room-container" class="room-container">
      <ng-container *ngFor="let room of rooms | roomPipe: state.searchText; let i = count">
>>>>>>> 82405296ee4629c705edeb98b90d1cd0ae5a844e
        <div *ngIf="room !== -1" class="date">
          <!-- Room header -->
          <div class="room-name">
            <div class="rotate">
              {{room.name}} 
              <span class="quantity">( {{room.slotRooms.length}} Slots)</span>
            </div>
          </div>
          <!-- Room-slot -->
          <div class="slot-group-container">
            <div class="slot example z-depth-2" *ngFor="let slot of room.slotRooms">
              <!-- <div class="slot-name">
                {{slot.name}}
              </div> -->
              <div [id]="slot.id" class="slot-container p-3" droppable [dropScope]="getScope(slot)"
                (onDrop)="dropNode($event)">
                <ng-container *ngIf="slot.surgeries?.length > 0; else noData">
                  <!-- Room Surgery -->
                  <app-schedule-card *ngFor="let surgery of slot.surgeries" [data]="surgery" [parentId]="slot.id"
                    [(swapMode)]="state.swapMode" (statusChange)="openStartShift($event)"
                    (openModal)="openModal($event)" [(selected)]="selected">
                  </app-schedule-card>
                </ng-container>
                <ng-template #noData>
                  <nz-card class="surgery nodata text-center">
                    <b>No record</b>
                  </nz-card>
                </ng-template>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="room === -1" class="noMatch">
          <h4>No Match</h4>
        </div>
      </ng-container>
    </div>
  </ng-container>
  <!--Modal-->
  <nz-modal [nzWidth]="'700px'" style="width: 40%" (nzOnCancel)="cancel()" [(nzVisible)]="isVisible"
    [nzTitle]="modalTitle" [nzContent]="modalContent" [nzFooter]="modalFooter">
    <ng-template #modalTitle>
      Change Schedule
    </ng-template>
    <ng-template #modalContent>
      <nz-tabset [nzTabPosition]="'left'">
        <nz-tab nzTitle="Duration">
          <app-duration #duration [id]="selectedObject?.id" (detectChanges)="this.state.reload = true"></app-duration>
        </nz-tab>
      </nz-tabset>
    </ng-template>
    <ng-template #modalFooter>
      <button nz-button nzType="default" (click)="cancel()">Close</button>
    </ng-template>
  </nz-modal>
  <!-- Modal -->
  <nz-modal [nzWidth]="'500px'" style="width: 40%;" (nzOnCancel)="isShowEmergency = false; createEmergencyForm()"
    [(nzVisible)]="isShowEmergency" [nzTitle]="'Emergency Shift'" [nzContent]="emergencyBody"
    [nzFooter]="emergencyFooter">
    <ng-template #emergencyBody>
      <nz-spin [nzSpinning]="state.create">
        <form *ngIf="emergencyForm" [formGroup]="emergencyForm">
          <div nz-row nzType="flex" nzJustify="space-between">
            <div>
              <nz-form-item>
                <nz-form-label>Start Time</nz-form-label>
                <nz-form-control>
                  <nz-date-picker [nzDisabledDate]="disabledStartDate" [nzShowTime]="{nzFormat: 'HH:mm'}"
                    nzFormat="dd/MM/yyyy - HH:mm" formControlName="startTime" nzPlaceHolder="Start Time">
                  </nz-date-picker>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div>
              <nz-form-item>
                <nz-form-label>End Time</nz-form-label>
                <nz-form-control>
                  <nz-date-picker [nzDisabledDate]="disabledEndDate" [nzShowTime]="{nzFormat: 'HH:mm'}"
                    nzFormat="dd/MM/yyyy - HH:mm" formControlName="endTime" nzPlaceHolder="End Time">
                  </nz-date-picker>
                </nz-form-control>
              </nz-form-item>  
            </div>
          </div>
          <div nz-row>
            <div nz-col nzSpan="12">
              <nz-form-item>
                <nz-form-control>
                  <label nz-checkbox formControlName="isForceAdd">
                    <span>Force Add Emergency</span>
                  </label>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div nz-col nzSpan="12">
              <nz-form-item>
                <nz-form-control>
                  <label>Slot Room</label>
                  <nz-select formControlName="slotRoomId" nzAllowClear nzPlaceHolder="Choose a slot room">
                    <nz-option *ngFor="let item of slotRooms" [nzLabel]="item.name"
                    [nzValue]="item.id"></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>
        </form>
      </nz-spin>
    </ng-template>
    <ng-template #emergencyFooter>
      <button [disabled]="state.create" nz-button nzType="default" class="mr-2"
        (click)="isShowEmergency = false; createEmergencyForm();">Close</button>
      <button [disabled]="state.create || emergencyForm.invalid" nz-button nzType="primary"
        (click)="createShift()">Create</button>
    </ng-template>
  </nz-modal>
  <!-- Loader -->
  <div *ngIf="loadingId" class="backdrop pos-absolute top-0 left-0 right-0 bottom-0"
    style="background: rgba(0,0,0,.5); z-index: 1000">
  </div>
</div>
<!-- Swal -->
<swal #moveNodeconfirm title="Swap Shift ?" [showCancelButton]="false" [showConfirmButton]="false"
  [showCloseButton]="true" (cancel)="setNode(null)">
  <div *swalPartial class="text-center pt-3">
    <button (click)="moveToRoom(false)" nz-button nzType="primary" class="mr-2">Swap</button>
    <button (click)="moveToRoom(true)" nz-button nzType="danger">Force Swap</button>
  </div>
</swal>

<nz-modal [(nzVisible)]="isShowStartModal" [nzTitle]="startTitle" [nzContent]="startContent" [nzFooter]="startFooter"
  (nzOnCancel)="startItem = null; isShowStartModal = false">
  <ng-template #startTitle>
    Change Intraoperative Status
  </ng-template>

  <ng-template #startContent>
    <p><b>Surgery Shift:</b> {{selectedObject?.id}} </p>
<<<<<<< HEAD
    <p *ngIf="!selectedObject?.actualStartDateTime"><b>Estimated Start Datetime:</b> {{selectedObject?.estimatedStartDateTime | date: 'dd/MM/yyyy - HH:mm'}} </p>
    <p *ngIf="selectedObject?.actualStartDateTime"><b>Start Datetime:</b> {{selectedObject?.actualStartDateTime | date: 'dd/MM/yyyy - HH:mm'}} </p>
    <p *ngIf="!selectedObject?.actualEndDateTime"><b>Estimated End Datetime:</b> {{selectedObject?.estimatedEndDateTime | date: 'dd/MM/yyyy - HH:mm'}}</p>
    <p *ngIf="selectedObject?.actualEndDateTime"><b>Estimated End Datetime:</b> {{selectedObject?.actualEndDateTime | date: 'dd/MM/yyyy - HH:mm'}}</p>
=======
    <p><b>Actual Start Time:</b> {{selectedObject?.actualStartDateTime | date: 'dd/MM/yyyy - HH:mm'}} </p>
>>>>>>> 82405296ee4629c705edeb98b90d1cd0ae5a844e
    <label class="mr-2">
      <b>Actual {{selectedObject?.statusName === 'Preoperative' ? 'Start' : 'End'}} Time:</b>
    </label>
    <nz-time-picker [nzFormat]="'HH:mm'" [(ngModel)]="selectedTime" (ngModelChange)="checkActualEndTime()"></nz-time-picker>
    <span
      style="color: red; padding-left: 10px;"
      *ngIf="actualEndTimeError">
      Invalid time
    </span>
    <div *ngIf="selectedObject?.statusName === 'Intraoperative'" class="row">
      <div class="col-6">
        <nz-form-item>
          <nz-form-label><b>Room</b></nz-form-label>
          <nz-form-control>
            <input nz-input [(ngModel)]="selectedRoom">
          </nz-form-control>
        </nz-form-item>
      </div>
      <div class="col-6">
        <nz-form-item>
          <nz-form-label><b>Bed</b></nz-form-label>
          <nz-form-control>
            <input nz-input [(ngModel)]="selectedBed">
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
  </ng-template>

  <ng-template #startFooter>
    <button nz-button nzType="default" (click)="startItem = null; isShowStartModal = false">Cancel</button>
    <button [disabled]="state.loadStart || !selectedTime" nz-button nzType="primary" (click)="startShift()"
      [nzLoading]="state.loadStart">{{selectedObject?.statusName === 'Preoperative' ? 'Save' : 'Complete'}}</button>
  </ng-template>
</nz-modal>